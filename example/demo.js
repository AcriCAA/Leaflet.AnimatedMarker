// This demo is based off of cibi.me by OpenPlans and my earlier visualization
// at http://github.com/openplans/cibi_animation

(function(){
  var bikeIcon = L.icon({
      iconUrl: 'marker-bike-green-shadowed.png',
      iconSize: new L.Point(25, 39),
      shadowUrl: null
  });

  var config = {
      tileUrl : 'http://{s}.tiles.mapbox.com/v3/mapbox.mapbox-light/{z}/{x}/{y}.png',
      overlayTileUrl : 'http://{s}.tiles.mapbox.com/v3/intertwine.nyc_bike_overlay/{z}/{x}/{y}.png',
      tileAttrib : 'Routing powered by <a href="http://opentripplanner.org/">OpenTripPlanner</a>, Map tiles &copy; Development Seed and OpenStreetMap ',
      initLatLng : new L.LatLng(40.719298,-73.999743), // NYC
      initZoom : 13,
      minZoom : 13,
      maxZoom : 17
  };

  var marker,
      map = new L.Map('map', {minZoom: config.minZoom, maxZoom: config.maxZoom}),
      routeLines = [
        L.polyline([[40.68510000, -73.94136000],[40.68576000, -73.94149000],[40.68649000, -73.94165000],[40.68722000, -73.94178000],[40.68795000, -73.94193000],[40.68869000, -73.94207000],[40.68942000, -73.94223000],[40.69016000, -73.94236000],[40.69089000, -73.94251000],[40.69162000, -73.94266000],[40.69234000, -73.94281000],[40.69309000, -73.94295000],[40.69337000, -73.94301000],[40.69382000, -73.94310000],[40.69455000, -73.94324000],[40.69527000, -73.94339000],[40.69603000, -73.94353000],[40.69822000, -73.94394000],[40.69897000, -73.94409000],[40.69968000, -73.94424000],[40.70042000, -73.94438000],[40.70053000, -73.94440000],[40.70109000, -73.94501000],[40.70165000, -73.94564000],[40.70221000, -73.94627000],[40.70277000, -73.94690000],[40.70335000, -73.94753000],[40.70388000, -73.94814000],[40.70407000, -73.94779000],[40.70436000, -73.94781000],[40.70544000, -73.94798000],[40.70685000, -73.94819000],[40.70759000, -73.94830000],[40.70830000, -73.94842000],[40.70901000, -73.94854000],[40.70879000, -73.95076000],[40.70914000, -73.95083000],[40.70971000, -73.95236000],[40.71026000, -73.95385000],[40.71059000, -73.95473000],[40.71055000, -73.95509000],[40.71058000, -73.95551000],[40.71065000, -73.95625000],[40.71065000, -73.95647000],[40.71051000, -73.95709000],[40.71044000, -73.95736000],[40.71035000, -73.95833000],[40.71032000, -73.95875000],[40.71078000, -73.95994000],[40.71103000, -73.96058000],[40.71047000, -73.96094000],[40.71041000, -73.96113000],[40.71061000, -73.96176000],[40.71115000, -73.96354000],[40.71162000, -73.96508000],[40.71217000, -73.96703000],[40.71215000, -73.96730000],[40.71549000, -73.97831000],[40.71544000, -73.97834000],[40.71757000, -73.98535000],[40.71770000, -73.98579000],[40.71783000, -73.98572000],[40.71908000, -73.98507000],[40.71933000, -73.98591000],[40.71958000, -73.98675000],[40.71983000, -73.98754000],[40.72007000, -73.98835000],[40.72030000, -73.98911000],[40.72046000, -73.98962000],[40.72052000, -73.98985000],[40.72076000, -73.99063000],[40.72102000, -73.99150000],[40.72115000, -73.99195000],[40.72124000, -73.99224000],[40.72139000, -73.99273000],[40.72161000, -73.99346000],[40.72234000, -73.99320000],[40.72238000, -73.99332000],[40.72272000, -73.99416000],[40.72303000, -73.99490000],[40.72336000, -73.99570000],[40.72368000, -73.99647000],[40.72388000, -73.99695000],[40.72423000, -73.99779000],[40.72462000, -73.99858000],[40.72500000, -73.99934000],[40.72538000, -74.00010000],[40.72576000, -74.00089000],[40.72611000, -74.00159000],[40.72649000, -74.00236000],[40.72687000, -74.00312000],[40.72690000, -74.00321000],[40.72694000, -74.00327000],[40.72695000, -74.00337000],[40.72695000, -74.00344000],[40.72766000, -74.00316000],[40.72831000, -74.00308000],[40.72838000, -74.00309000],[40.72871000, -74.00330000],[40.72934000, -74.00365000],[40.72987000, -74.00397000],[40.73044000, -74.00430000],[40.73071000, -74.00446000],[40.73100000, -74.00462000],[40.73154000, -74.00493000],[40.73135000, -74.00553000],[40.73162000, -74.00570000],[40.73158000, -74.00578000],[40.73163000, -74.00632000]]),
        L.polyline([[40.73271000, -73.99818000],[40.73261000, -73.99828000],[40.73221000, -73.99861000],[40.73192000, -73.99849000],[40.73118000, -73.99819000],[40.73096000, -73.99773000],[40.73093000, -73.99775000],[40.73088000, -73.99776000],[40.73078000, -73.99774000],[40.73071000, -73.99766000],[40.73049000, -73.99788000],[40.73028000, -73.99749000],[40.72987000, -73.99667000],[40.72955000, -73.99655000],[40.72918000, -73.99582000],[40.72881000, -73.99506000],[40.72840000, -73.99425000],[40.72815000, -73.99372000],[40.72786000, -73.99314000],[40.72711000, -73.99161000],[40.72705000, -73.99148000],[40.72618000, -73.98942000],[40.72558000, -73.98987000],[40.72518000, -73.99016000],[40.72491000, -73.99034000],[40.72426000, -73.99082000],[40.72402000, -73.99103000],[40.72365000, -73.99101000],[40.72240000, -73.99164000],[40.72218000, -73.99091000],[40.72191000, -73.99004000],[40.72167000, -73.98924000],[40.72161000, -73.98903000],[40.72146000, -73.98852000],[40.72123000, -73.98776000],[40.72097000, -73.98695000],[40.72074000, -73.98615000],[40.72048000, -73.98531000],[40.71933000, -73.98591000],[40.71808000, -73.98655000],[40.71797000, -73.98660000],[40.71770000, -73.98579000],[40.71757000, -73.98535000],[40.71544000, -73.97834000],[40.71538000, -73.97837000],[40.71203000, -73.96735000],[40.71186000, -73.96721000],[40.71125000, -73.96529000],[40.71092000, -73.96426000],[40.71074000, -73.96366000],[40.71121000, -73.96337000],[40.71190000, -73.96294000],[40.71244000, -73.96446000],[40.71307000, -73.96408000],[40.71382000, -73.96360000],[40.71445000, -73.96320000],[40.71510000, -73.96278000],[40.71558000, -73.96229000],[40.71593000, -73.96191000],[40.71638000, -73.96142000],[40.71697000, -73.96079000],[40.71752000, -73.96019000],[40.71808000, -73.95960000],[40.71862000, -73.95900000],[40.71904000, -73.95856000]]),
        L.polyline([[40.72022000, -74.00005000],[40.72043000, -73.99986000],[40.72142000, -73.99904000],[40.72265000, -73.99798000],[40.72388000, -73.99695000],[40.72466000, -73.99631000],[40.72520000, -73.99584000],[40.72508000, -73.99533000],[40.72585000, -73.99471000],[40.72593000, -73.99464000],[40.72601000, -73.99458000],[40.72626000, -73.99440000],[40.72664000, -73.99412000],[40.72728000, -73.99364000],[40.72786000, -73.99314000],[40.72988000, -73.99141000],[40.72979000, -73.99074000],[40.72974000, -73.99036000],[40.72955000, -73.98991000],[40.72988000, -73.98966000],[40.72990000, -73.98891000],[40.72999000, -73.98736000],[40.72977000, -73.98682000],[40.72878000, -73.98443000],[40.72937000, -73.98400000],[40.73001000, -73.98353000],[40.73064000, -73.98306000],[40.73135000, -73.98255000],[40.73202000, -73.98206000],[40.73221000, -73.98192000],[40.73265000, -73.98160000],[40.73325000, -73.98115000],[40.73382000, -73.98073000],[40.73406000, -73.98056000],[40.73442000, -73.98030000],[40.73498000, -73.97990000],[40.73558000, -73.97943000],[40.73619000, -73.97899000],[40.73687000, -73.97851000],[40.73755000, -73.97805000],[40.73816000, -73.97760000],[40.73879000, -73.97715000],[40.73941000, -73.97670000],[40.74002000, -73.97625000],[40.74013000, -73.97616000],[40.74064000, -73.97581000],[40.74127000, -73.97534000],[40.74145000, -73.97521000],[40.74217000, -73.97467000],[40.74309000, -73.97402000],[40.74378000, -73.97351000],[40.74445000, -73.97303000],[40.74506000, -73.97257000],[40.74568000, -73.97212000],[40.74629000, -73.97167000],[40.74692000, -73.97122000],[40.74751000, -73.97073000],[40.74783000, -73.97049000],[40.74865000, -73.96990000],[40.75200000, -73.96746000],[40.75283000, -73.96690000],[40.75312000, -73.96669000],[40.75324000, -73.96661000],[40.75334000, -73.96654000],[40.75387000, -73.96615000],[40.75450000, -73.96569000],[40.75513000, -73.96524000],[40.75575000, -73.96478000],[40.75638000, -73.96432000],[40.75700000, -73.96387000],[40.75763000, -73.96341000],[40.75831000, -73.96292000],[40.75898000, -73.96243000],[40.75961000, -73.96197000],[40.76023000, -73.96152000],[40.76023000, -73.96163000],[40.76071000, -73.96278000],[40.76068000, -73.96280000],[40.76061000, -73.96276000],[40.76017000, -73.96168000],[40.75956000, -73.96033000],[40.75797000, -73.95673000],[40.75521000, -73.95040000],[40.75353000, -73.94654000],[40.75148000, -73.94183000],[40.75105000, -73.94082000],[40.75106000, -73.94068000],[40.75108000, -73.94075000]])
      ];

  map.addLayer(new L.TileLayer(config.tileUrl, {attribution: config.tileAttrib}));
  map.addLayer(new L.TileLayer(config.overlayTileUrl));
  map.setView(config.initLatLng, config.initZoom);


  $.each(routeLines, function(i, routeLine) {
    var marker = new L.AnimatedMarker(routeLine.getLatLngs(), {
      icon: bikeIcon,
      autoStart: false,
      onEnd: function() {
        $(this._shadow).fadeOut();
        $(this._icon).fadeOut(3000, function(){
          map.removeLayer(this);
        });
      }
    });

    map.addLayer(marker);

    $(marker._icon).hide().fadeIn(1000, function(){
      marker.start();
    });
  });
})();